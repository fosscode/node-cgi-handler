# NGINX Configuration for node-cgi-handler (CGI mode via fcgiwrap)
#
# This configuration runs Node.js scripts per-request via fcgiwrap,
# similar to how PHP-FPM works but for Node.js.
#
# Prerequisites:
#   1. Install fcgiwrap: apt install fcgiwrap
#   2. Ensure fcgiwrap socket exists: /var/run/fcgiwrap.socket
#   3. Install node-cgi-handler globally: npm install -g node-cgi-handler

server {
    listen 80;
    server_name example.com;

    root /var/www/myapp;
    index index.html index.js;

    # Serve static files directly
    location / {
        try_files $uri $uri/ =404;
    }

    # Run .js files as CGI scripts
    location ~ \.js$ {
        # Disable gzip for CGI
        gzip off;

        # fcgiwrap socket
        fastcgi_pass unix:/var/run/fcgiwrap.socket;

        # Include standard FastCGI params
        include fastcgi_params;

        # IMPORTANT: Use node-cgi as the script runner
        # This allows the node-cgi CLI to handle the CGI protocol
        fastcgi_param SCRIPT_FILENAME /usr/local/bin/node-cgi;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;

        # Pass the actual .js file path in a custom variable
        fastcgi_param NODE_SCRIPT $document_root$fastcgi_script_name;

        # Or use the direct approach where each .js file uses node-cgi-handler:
        # fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # Request details
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_param DOCUMENT_ROOT $document_root;
    }
}

# Alternative: Using spawn-fcgi to run Node.js scripts
# This keeps a pool of Node.js processes ready to handle requests
#
# Start with: spawn-fcgi -s /var/run/node-cgi.sock -n -- node-cgi --fastcgi
#
# Then use:
#   location ~ \.js$ {
#       fastcgi_pass unix:/var/run/node-cgi.sock;
#       include fastcgi_params;
#       fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#   }
